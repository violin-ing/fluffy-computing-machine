<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wordle Solver</title>
    <style>
        :root {
            --bg-color: #3a3a3d;
            --tile-border: #3a3a3c;
            --tile-text: #ffffff;
            --color-absent: #3a3a3c;  /* 'w' - Gray */
            --color-present: #b59f3b; /* 'y' - Yellow */
            --color-correct: #538d4e; /* 'g' - Green */
        }

        body {
            background-color: var(--bg-color);
            color: var(--tile-text);
            font-family: 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        h1 { margin-bottom: 20px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; }

        /* Game Board */
        #board-container {
            display: grid;
            grid-template-rows: repeat(6, 1fr);
            gap: 5px;
            margin-bottom: 30px;
        }

        .row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }

        .tile {
            width: 62px; height: 62px;
            border: 2px solid var(--tile-border);
            display: inline-flex;
            justify-content: center; align-items: center;
            font-size: 2rem; font-weight: bold;
            text-transform: uppercase; user-select: none;
            cursor: pointer; transition: all 0.1s ease;
        }

        /* Tile States */
        .tile[data-state='empty'] { background-color: transparent; cursor: default; }
        .tile[data-state='absent'] { background-color: var(--color-absent); border-color: var(--color-absent); }
        .tile[data-state='present'] { background-color: var(--color-present); border-color: var(--color-present); }
        .tile[data-state='correct'] { background-color: var(--color-correct); border-color: var(--color-correct); }
        
        /* Locked State (Visual feedback that it's unclickable) */
        .tile.locked { cursor: default; opacity: 0.8; }

        /* Controls */
        #controls { display: flex; gap: 10px; flex-direction: column; align-items: center; }

        button.action-btn {
            padding: 15px 30px;
            font-size: 1rem; font-weight: bold;
            background-color: white; color: black;
            border: none; border-radius: 4px;
            cursor: pointer; text-transform: uppercase;
        }
        button.action-btn:hover { background-color: #e2e2e2; }
        button.action-btn:disabled { background-color: #555; cursor: not-allowed; color: #888; }

        /* Restart Button (Red) */
        #restart-btn {
            background-color: #d9534f; color: white;
            display: none; 
        }
        #restart-btn:hover { background-color: #c9302c; }

        /* Modal / Popups */
        .hidden { display: none !important; }

        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex; justify-content: center; align-items: center;
            z-index: 100;
        }

        .modal-content {
            background: #121213; border: 1px solid #3a3a3c;
            padding: 40px; text-align: center; border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            min-width: 300px;
        }

        .modal-content h2 { margin-top: 0; font-size: 2rem; margin-bottom: 10px;}
        .modal-content p { font-size: 1.2rem; margin-bottom: 30px; color: #ccc; }
        
        .text-win { color: #538d4e; } 
        .text-loss { color: #d9534f; }
        .text-error { color: #d9534f; }

        .modal-content button {
            padding: 10px 20px; font-size: 1rem; font-weight: bold;
            background: #fff; border: none; cursor: pointer; border-radius: 4px;
        }
    </style>
</head>
<body>

    <h1>Wordle Solver</h1>

    <div id="board-container">
        </div>

    <div id="controls">
        <button id="submit-hints" class="action-btn">Submit</button>
        <button id="restart-btn" class="action-btn">Restart</button>
    </div>

    <div id="modal-overlay" class="hidden">
        <div class="modal-content">
            <h2 id="modal-title">TITLE</h2>
            <p id="modal-msg">Message goes here</p>
            <button onclick="closeModal()">Close</button>
        </div>
    </div>

    <script>
        const ROWS = 6;
        const COLS = 5;
        let currentRowIndex = 0; 
        let isGameOver = false; // New flag to stop clicks on game over
        const STATE_CYCLE = ['absent', 'present', 'correct'];

        // DOM Elements
        const submitBtn = document.getElementById('submit-hints');
        const restartBtn = document.getElementById('restart-btn');
        const modal = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalMsg = document.getElementById('modal-msg');

        // --- BOARD LOGIC ---

        function initBoard() {
            const board = document.getElementById('board-container');
            board.innerHTML = ''; 
            
            for (let r = 0; r < ROWS; r++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';
                for (let c = 0; c < COLS; c++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    tile.id = `tile-${r}-${c}`;
                    tile.setAttribute('data-state', 'empty');
                    
                    // PASS THE ROW INDEX (r) HERE
                    tile.addEventListener('click', () => toggleTileState(tile, r));
                    
                    rowDiv.appendChild(tile);
                }
                board.appendChild(rowDiv);
            }
        }

        function toggleTileState(tile, rowIdx) {
            // 1. If Game is Over, lock everything
            if (isGameOver) return;

            // 2. Prevent changing empty tiles
            if (tile.innerText === '') return;

            // 3. LOCK LOGIC: 
            // Only allow clicking if this tile belongs to the row currently being played.
            // currentRowIndex points to the *next* empty row, so the active row is (currentRowIndex - 1).
            if (rowIdx !== currentRowIndex - 1) return;

            // Cycle Colors
            const currentState = tile.getAttribute('data-state');
            let nextState = 'absent';
            
            if (currentState !== 'empty') {
                const currentIndex = STATE_CYCLE.indexOf(currentState);
                const nextIndex = (currentIndex + 1) % STATE_CYCLE.length;
                nextState = STATE_CYCLE[nextIndex];
            }
            tile.setAttribute('data-state', nextState);
        }

        function generateHintString() {
            if (currentRowIndex === 0) return null;
            const activeRow = currentRowIndex - 1;
            let hintString = "";
            
            for (let i = 0; i < COLS; i++) {
                const tile = document.getElementById(`tile-${activeRow}-${i}`);
                const state = tile.getAttribute('data-state');
                
                if (state === 'correct') hintString += 'g';
                else if (state === 'present') hintString += 'y';
                else hintString += 'w'; 
            }
            return hintString;
        }

        function botGuess(word) {
            if (currentRowIndex >= ROWS) return;
            word = word.toUpperCase();
            
            // 1. Lock the previous row visually (optional, adds cursor: default)
            if (currentRowIndex > 0) {
                const prevRow = currentRowIndex - 1;
                for(let i=0; i<COLS; i++) {
                    document.getElementById(`tile-${prevRow}-${i}`).classList.add('locked');
                }
            }

            // 2. Fill the new row
            for (let i = 0; i < COLS; i++) {
                const tile = document.getElementById(`tile-${currentRowIndex}-${i}`);
                tile.innerText = word[i];
                tile.setAttribute('data-state', 'absent'); 
                // Ensure new row is not visually locked
                tile.classList.remove('locked');
            }
            currentRowIndex++;
        }

        // --- GAME STATE & MODALS ---

        function handleGameOver() {
            isGameOver = true; // Lock the board
            submitBtn.style.display = 'none'; 
            restartBtn.style.display = 'inline-block'; 
            
            // Visually lock the last row too
            const lastRow = currentRowIndex - 1;
            for(let i=0; i<COLS; i++) {
                const tile = document.getElementById(`tile-${lastRow}-${i}`);
                if(tile) tile.classList.add('locked');
            }
        }

        function showModal(type, msg) {
            modalTitle.className = '';
            
            if (type === 'win') {
                modalTitle.innerText = "VICTORY!";
                modalTitle.classList.add('text-win');
                modalMsg.innerText = msg || "The bot found the word!";
            } else if (type === 'loss') {
                modalTitle.innerText = "SORRY";
                modalTitle.classList.add('text-loss');
                modalMsg.innerText = msg || "The bot ran out of guesses.";
            } else {
                modalTitle.innerText = "ERROR";
                modalTitle.classList.add('text-error');
                modalMsg.innerText = msg || "Something went wrong.";
            }

            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        // RESTART BUTTON CLICK
        restartBtn.addEventListener('click', () => {
            // Reset State
            currentRowIndex = 0;
            isGameOver = false;
            
            // Reset UI
            restartBtn.style.display = 'none';
            submitBtn.style.display = 'inline-block';
            submitBtn.disabled = false;
            submitBtn.innerText = "Submit";
            
            initBoard(); 
            startGame();
        });

        // SUBMIT BUTTON CLICK
        submitBtn.addEventListener('click', () => {
            const resultString = generateHintString();
            if (!resultString) return;

            // 1. Check for Victory
            if (resultString === 'ggggg') {
                showModal('win', "Bot found the word!");
                handleGameOver();
                return;
            }

            // 2. Check for Loss (Board Full)
            if (currentRowIndex === ROWS) {
                showModal('loss', "Bot failed to solve it within 6 tries.");
                handleGameOver();
                return;
            }

            // 3. Normal turn
            submitBtn.innerText = "Thinking...";
            submitBtn.disabled = true;

            fetch('https://wordle-solver-bot.onrender.com/api/next-guess', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hints: resultString })
            })
            .then(res => res.json())
            .then(data => {
                if(data.error) {
                    showModal('error', data.error);
                } else {
                    botGuess(data.next_word);
                }
            })
            .catch(err => showModal('error', "Could not connect to backend."))
            .finally(() => {
                submitBtn.innerText = "Submit";
                submitBtn.disabled = false;
            });
        });

        // --- INITIALIZATION ---
        
        function startGame() {
            fetch('https://wordle-solver-bot.onrender.com/api/start-game', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                botGuess(data.next_word);
            })
            .catch(err => {
                console.error(err);
                showModal('error', "Is the backend running?");
            });
        }

        initBoard();
        startGame();

    </script>
</body>
</html>